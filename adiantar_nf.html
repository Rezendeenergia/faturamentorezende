<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adiantar Nota Fiscal - Sistema Rezende</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .nf-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nf-info {
            flex: 1;
            min-width: 300px;
        }

        .nf-info h3 {
            margin: 0 0 10px 0;
            color: #1e293b;
        }

        .nf-info p {
            margin: 5px 0;
            color: #64748b;
            font-size: 0.9rem;
        }

        .nf-actions {
            display: flex;
            gap: 10px;
        }

        .badge-adiantado {
            background: #dbeafe;
            color: #2563eb;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-nao-adiantado {
            background: #f1f5f9;
            color: #64748b;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí≥ Adiantar Nota Fiscal</h1>
            <p>Gerencie adiantamentos e reten√ß√µes</p>
        </header>

        <div style="display: flex; gap: 10px; margin-bottom: 30px;">
            <a href="/" class="btn btn-secondary">‚Üê Voltar</a>
            <a href="/dashboard" class="btn btn-secondary">üìä Dashboard</a>
        </div>

        <main>
            <section>
                <h2>üìã Notas Fiscais Dispon√≠veis</h2>
                <p style="color: #64748b; margin-bottom: 20px;">
                    Selecione uma nota fiscal para adicionar informa√ß√µes de adiantamento
                </p>

            <!-- ADICIONAR AQUI (linha ~52, antes de "Notas Fiscais Dispon√≠veis") -->
            <section>
                <h2>üîç Filtros</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="todas" onclick="filtrarNotas('todas')">
                        üìã Todas
                    </button>
                    <button class="filter-btn" data-filter="nao-adiantadas" onclick="filtrarNotas('nao-adiantadas')">
                        ‚è≥ N√£o Adiantadas
                    </button>
                    <button class="filter-btn" data-filter="adiantadas" onclick="filtrarNotas('adiantadas')">
                        ‚úÖ Adiantadas
                    </button>
                </div>
                <p id="contador" style="color: #64748b; margin-top: 15px;">
                    <!-- Contador din√¢mico -->
                </p>
            </section>


                <div id="listaNotas">
                    <div style="text-align: center; padding: 40px;">
                        Carregando notas fiscais...
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Sistema de Controle Financeiro - Rezende Constru√ß√£o e Manuten√ß√£o LTDA</p>
        </footer>
    </div>

    <!-- Modal de Adiantamento -->
    <div id="adiantamentoModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin-bottom: 20px;">üí≥ Adiantar Nota Fiscal <span id="modalNFNumero"></span></h3>

            <form id="adiantamentoForm">
                <input type="hidden" id="nfId">

                <div class="info-box" style="margin-bottom: 20px;">
                    <p><strong>Valor Nominal:</strong> <span id="modalValorNominal">R$ 0,00</span></p>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="pisRetido">
                        PIS/COFINS/CSLL foi retido? (4,65%)
                    </label>
                </div>

                <div class="form-group">
                    <label for="dataAdiantamento">Data do Adiantamento *</label>
                    <input type="date" id="dataAdiantamento" required>
                </div>

                <div class="form-group">
                    <label for="valorLiquidoVinci">Valor L√≠quido Recebido (Vinci) *</label>
                    <input type="number" id="valorLiquidoVinci" step="0.01" required placeholder="0.00">
                    <small style="color: #64748b;">Digite o valor que realmente caiu na conta</small>
                </div>

                <div class="info-box" id="calculoJuros" style="display: none; margin-top: 20px;">
                    <p><strong>üìä C√°lculo Autom√°tico:</strong></p>
                    <p>‚Ä¢ Juros Pagos: <strong>R$ <span id="jurosCalculado">0,00</span></strong></p>
                    <p>‚Ä¢ Percentual: <strong><span id="percentualCalculado">0,00</span>%</strong></p>
                </div>

                <div class="form-actions" style="margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalAdiantamento()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Adiantamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="successModal" class="modal">
        <div class="modal-content success">
            <span class="modal-icon">‚úÖ</span>
            <h3>Adiantamento Salvo!</h3>
            <p id="successMessage"></p>
            <button class="btn btn-primary" onclick="fecharModal()">OK</button>
        </div>
    </div>

    <!-- Modal de Erro -->
    <div id="errorModal" class="modal">
        <div class="modal-content error">
            <span class="modal-icon">‚ùå</span>
            <h3>Erro</h3>
            <p id="errorMessage"></p>
            <button class="btn btn-secondary" onclick="fecharModal()">Fechar</button>
        </div>
    </div>

    <script>
        let notaAtual = null;
        let todasAsNotas = []; // Armazena todas as notas
        let filtroAtual = 'todas'; // Filtro ativo

        document.addEventListener('DOMContentLoaded', () => {
            carregarNotas();
        });

        async function carregarNotas() {
            try {
                const response = await fetch('/api/todas-notas');
                const result = await response.json();

                if (result.success) {
                    todasAsNotas = result.notas; // Salva globalmente
                    aplicarFiltro(); // Aplica filtro (inicialmente 'todas')
                }
            } catch (error) {
                console.error('Erro ao carregar notas:', error);
            }
        }

        // ===== FUN√á√ïES DE FILTRO =====
        function filtrarNotas(filtro) {
            filtroAtual = filtro;

            // Atualiza bot√µes ativos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filtro}"]`).classList.add('active');

            // Aplica filtro
            aplicarFiltro();
        }

        function aplicarFiltro() {
            const container = document.getElementById('listaNotas');

            if (todasAsNotas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        Nenhuma nota fiscal cadastrada ainda
                    </div>
                `;
                atualizarContador(0, 0);
                return;
            }

            // Filtra notas
            let notasFiltradas = todasAsNotas;

            if (filtroAtual === 'adiantadas') {
                notasFiltradas = todasAsNotas.filter(nota => nota.foi_adiantado === 1);
            } else if (filtroAtual === 'nao-adiantadas') {
                notasFiltradas = todasAsNotas.filter(nota => nota.foi_adiantado !== 1);
            }

            // Renderiza
            if (notasFiltradas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        Nenhuma nota encontrada com este filtro
                    </div>
                `;
                atualizarContador(0, todasAsNotas.length);
                return;
            }

            container.innerHTML = notasFiltradas.map(nota => {
                const foiAdiantado = nota.foi_adiantado === 1;
                const badgeClass = foiAdiantado ? 'badge-adiantado' : 'badge-nao-adiantado';
                const badgeText = foiAdiantado ? '‚úì Adiantado' : 'N√£o adiantado';

                return `
                    <div class="nf-item">
                        <div class="nf-info">
                            <h3>NF ${nota.numero_nf} - ${nota.tipo}</h3>
                            <p><strong>Emiss√£o:</strong> ${formatarData(nota.data_emissao)} | <strong>Valor Bruto:</strong> ${formatarMoeda(nota.valor_bruto)}</p>
                            <p><strong>Tomador:</strong> ${nota.tomador || '-'} | <strong>Localidade:</strong> ${nota.localidade || '-'}</p>
                            <p><strong>Valor Nominal:</strong> ${formatarMoeda(nota.valor_nominal_calculado)}</p>
                            ${foiAdiantado ? `<p><strong>Valor L√≠quido Vinci:</strong> ${formatarMoeda(nota.valor_liquido_vinci)}</p>` : ''}
                        </div>
                        <div class="nf-actions">
                            <span class="${badgeClass}">${badgeText}</span>
                            <button class="btn btn-primary" onclick='abrirModalAdiantamento(${JSON.stringify(nota).replace(/'/g, "&#39;")})'>
                                ${foiAdiantado ? 'Editar' : 'Adiantar'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            atualizarContador(notasFiltradas.length, todasAsNotas.length);
        }

        function atualizarContador(filtradas, total) {
            const contador = document.getElementById('contador');

            if (filtroAtual === 'todas') {
                contador.innerHTML = `Mostrando <strong>${total}</strong> notas fiscais`;
            } else {
                contador.innerHTML = `Mostrando <strong>${filtradas}</strong> de <strong>${total}</strong> notas fiscais`;
            }
        }

        // ===== MODAL DE ADIANTAMENTO =====
        function abrirModalAdiantamento(nota) {
            notaAtual = nota;

            document.getElementById('nfId').value = nota.id;
            document.getElementById('modalNFNumero').textContent = nota.numero_nf;
            document.getElementById('modalValorNominal').textContent = formatarMoeda(nota.valor_nominal_calculado);

            // Preenche dados se j√° foi adiantado
            if (nota.foi_adiantado === 1) {
                document.getElementById('pisRetido').checked = nota.pis_cofins_retido === 1;
                document.getElementById('dataAdiantamento').value = nota.data_adiantamento ? nota.data_adiantamento.split('T')[0] : '';
                document.getElementById('valorLiquidoVinci').value = nota.valor_liquido_vinci || '';
                calcularJuros();
            } else {
                document.getElementById('adiantamentoForm').reset();
                document.getElementById('calculoJuros').style.display = 'none';
            }

            document.getElementById('adiantamentoModal').classList.add('show');
        }

        // Calcula juros em tempo real
        document.getElementById('valorLiquidoVinci').addEventListener('input', calcularJuros);
        document.getElementById('pisRetido').addEventListener('change', calcularJuros);

        function calcularJuros() {
            if (!notaAtual) return;

            const pisRetido = document.getElementById('pisRetido').checked;
            const valorLiquido = parseFloat(document.getElementById('valorLiquidoVinci').value) || 0;

            if (valorLiquido <= 0) {
                document.getElementById('calculoJuros').style.display = 'none';
                return;
            }

            let valorNominal = notaAtual.valor_nominal_calculado;

            // Se PIS retido, desconta do nominal
            if (pisRetido) {
                valorNominal -= notaAtual.pis_cofins_csll || 0;
            }

            const juros = valorNominal - valorLiquido;
            const percentual = (juros / valorNominal) * 100;

            document.getElementById('jurosCalculado').textContent = juros.toFixed(2);
            document.getElementById('percentualCalculado').textContent = percentual.toFixed(2);
            document.getElementById('calculoJuros').style.display = 'block';
        }

        // Submeter formul√°rio
        document.getElementById('adiantamentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const dados = {
                nota_id: parseInt(document.getElementById('nfId').value),
                pis_cofins_retido: document.getElementById('pisRetido').checked,
                data_adiantamento: document.getElementById('dataAdiantamento').value,
                valor_liquido_vinci: parseFloat(document.getElementById('valorLiquidoVinci').value)
            };

            try {
                const response = await fetch('/api/adiantar-nota', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();

                if (result.success) {
                    mostrarSucesso('Adiantamento salvo com sucesso!');
                    fecharModalAdiantamento();
                    setTimeout(() => {
                        fecharModal();
                        carregarNotas(); // Recarrega notas
                    }, 1500);
                } else {
                    mostrarErro(result.error || 'Erro ao salvar adiantamento.');
                }
            } catch (error) {
                mostrarErro('Erro ao salvar: ' + error.message);
            }
        });

        function fecharModalAdiantamento() {
            document.getElementById('adiantamentoModal').classList.remove('show');
            notaAtual = null;
        }

        // ===== FUN√á√ïES AUXILIARES =====
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function formatarData(data) {
            if (!data) return '-';
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function mostrarSucesso(mensagem) {
            const modal = document.getElementById('successModal');
            const messageEl = document.getElementById('successMessage');
            messageEl.textContent = mensagem;
            modal.classList.add('show');
        }

        function mostrarErro(mensagem) {
            const modal = document.getElementById('errorModal');
            const messageEl = document.getElementById('errorMessage');
            messageEl.textContent = mensagem;
            modal.classList.add('show');
        }

        function fecharModal() {
            document.getElementById('successModal').classList.remove('show');
            document.getElementById('errorModal').classList.remove('show');
        }

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'adiantamentoModal') {
                    fecharModalAdiantamento();
                } else {
                    fecharModal();
                }
            }
        });
    </script>
</body>
</html>