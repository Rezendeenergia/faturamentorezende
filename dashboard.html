<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Controle de Recebimentos</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .dashboard-card.recebido {
            border-left-color: #16a34a;
        }

        .dashboard-card.a-receber {
            border-left-color: #f59e0b;
        }

        .dashboard-card.atrasado {
            border-left-color: #dc2626;
        }

        .dashboard-card.juros {
            border-left-color: #8b5cf6;
        }

        .dashboard-card.retencao {
            border-left-color: #06b6d4;
        }

        .dashboard-card.iss {
            border-left-color: #f97316;
        }

        .dashboard-card.inss {
            border-left-color: #ec4899;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            color: #64748b;
            margin-bottom: 15px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
        }

        .card-subtitle {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 5px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .filters-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #64748b;
        }

        .filter-group select {
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #e2e8f0;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .nav-tab:hover {
            color: #1e40af;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8fafc;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge.recebido {
            background: #d1fae5;
            color: #16a34a;
        }

        .badge.a-receber {
            background: #fef3c7;
            color: #f59e0b;
        }

        .badge.atrasado {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge.parcial {
            background: #dbeafe;
            color: #2563eb;
        }

        .badge.pendente {
            background: #f1f5f9;
            color: #64748b;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Dashboard de Recebimentos</h1>
            <p>Controle Financeiro Rezende</p>
        </header>

        <div class="top-bar">
            <div class="btn-group">
                <a href="/" class="btn btn-secondary">‚Üê Cadastrar NF</a>
                <a href="/extrato" class="btn btn-secondary">üí∞ Gerenciar Extrato</a>
                <a href="/adiantar" class="btn btn-secondary">üí≥ Adiantar NF</a>
            </div>
            <button class="btn btn-primary" onclick="atualizarDashboard()">üîÑ Atualizar</button>
        </div>

        <main>
            <!-- LINHA 1: Status de Recebimentos -->
            <div class="section-title">üí∞ Status de Recebimentos</div>
            <div class="dashboard-grid">
                <div class="dashboard-card recebido">
                    <div class="card-title">
                        <span>üü¢</span>
                        <span>RECEBIDO</span>
                    </div>
                    <div class="card-value" id="valorRecebido">R$ 0,00</div>
                    <div class="card-subtitle"><span id="qtdRecebido">0</span> notas fiscais</div>
                </div>

                <div class="dashboard-card a-receber">
                    <div class="card-title">
                        <span>üü°</span>
                        <span>A RECEBER</span>
                    </div>
                    <div class="card-value" id="valorAReceber">R$ 0,00</div>
                    <div class="card-subtitle"><span id="qtdAReceber">0</span> notas fiscais</div>
                </div>

                <div class="dashboard-card atrasado">
                    <div class="card-title">
                        <span>üî¥</span>
                        <span>ATRASADO</span>
                    </div>
                    <div class="card-value" id="valorAtrasado">R$ 0,00</div>
                    <div class="card-subtitle"><span id="qtdAtrasado">0</span> notas fiscais</div>
                </div>
            </div>

            <!-- LINHA 2: An√°lise Financeira -->
            <div class="section-title">üìà An√°lise Financeira</div>
            <div class="dashboard-grid">
                <div class="dashboard-card juros">
                    <div class="card-title">
                        <span>üí∏</span>
                        <span>JUROS DE ADIANTAMENTO</span>
                    </div>
                    <div class="card-value" id="valorJuros">R$ 0,00</div>
                    <div class="card-subtitle">Total gasto com adiantamentos</div>
                </div>

                <div class="dashboard-card retencao">
                    <div class="card-title">
                        <span>üîÑ</span>
                        <span>RETEN√á√ÉO EQUATORIAL</span>
                    </div>
                    <div class="card-value" id="valorRetencaoEquatorial">R$ 0,00</div>
                    <div class="card-subtitle">A recuperar</div>
                </div>

                <div class="dashboard-card iss">
                    <div class="card-title">
                        <span>üìä</span>
                        <span>ISS RETIDO</span>
                    </div>
                    <div class="card-value" id="valorISS">R$ 0,00</div>
                    <div class="card-subtitle">Total de ISS descontado</div>
                </div>

                <div class="dashboard-card inss">
                    <div class="card-title">
                        <span>üìä</span>
                        <span>INSS RETIDO</span>
                    </div>
                    <div class="card-value" id="valorINSS">R$ 0,00</div>
                    <div class="card-subtitle">Total de INSS descontado</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters-bar" style="margin-top: 40px;">
                <div class="filter-group">
                    <label for="filtroTipo">üè∑Ô∏è Tipo de Servi√ßo:</label>
                    <select id="filtroTipo" onchange="filtrarTabela()">
                        <option value="">Todos os Tipos</option>
                        <option value="CONSTRUCAO">Constru√ß√£o</option>
                        <option value="ENSAIO DIELETRICO">Ensaio Diel√©trico</option>
                        <option value="TRANSPORTE">Transporte (NF)</option>
                        <option value="TRANSPORTE_CTE">Transporte (CT-e)</option>
                    </select>
                </div>
            </div>

            <!-- Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="atrasados">üî¥ Atrasados</button>
                <button class="nav-tab" data-tab="a-receber">üü° A Receber</button>
                <button class="nav-tab" data-tab="todas">üìã Todas as NFs</button>
            </div>

            <!-- Tabela de Notas -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>NF</th>
                            <th>Data Emiss√£o</th>
                            <th>Tipo</th>
                            <th>Tomador</th>
                            <th>Valor L√≠quido</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th>Situa√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaNotas">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                Carregando dados...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        let notasData = [];
        let todosOsDados = {
            recebido: { qtd: 0, total: 0 },
            a_receber: { qtd: 0, total: 0 },
            atrasado: { qtd: 0, total: 0 }
        };
        let analiseFinanceira = {
            juros: 0,
            retencao_equatorial: 0,
            iss: 0,
            inss: 0
        };

        // Carrega dados ao iniciar
        document.addEventListener('DOMContentLoaded', () => {
            atualizarDashboard();
            configurarTabs();
        });

        async function atualizarDashboard() {
            try {
                const response = await fetch('/api/dashboard-data');
                const result = await response.json();

                if (result.success) {
                    todosOsDados = result.dashboard;
                    analiseFinanceira = result.analise_financeira;
                    notasData = result.pendentes;

                    recalcularCards();
                    atualizarCardsFinanceiros();
                    filtrarTabela();
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        function recalcularCards() {
            const tipoSelecionado = document.getElementById('filtroTipo').value;

            if (tipoSelecionado === '') {
                // Sem filtro - mostra totais gerais
                atualizarCards(todosOsDados);
                return;
            }

            // Com filtro - recalcula baseado no tipo selecionado
            const notasFiltradas = notasData.filter(nota => nota.tipo === tipoSelecionado);

            let recebido = { qtd: 0, total: 0 };
            let a_receber = { qtd: 0, total: 0 };
            let atrasado = { qtd: 0, total: 0 };

            notasFiltradas.forEach(nota => {
                // USA APENAS Valor Nominal Confer√™ncia (coluna M)
                const valorLiquido = nota.valor_liquido || 0;

                if (nota.status_recebimento === 'RECEBIDO') {
                    recebido.qtd++;
                    recebido.total += valorLiquido;
                } else if (nota.situacao === 'ATRASADO') {
                    atrasado.qtd++;
                    atrasado.total += valorLiquido;
                } else if (nota.situacao === 'A_RECEBER') {
                    a_receber.qtd++;
                    a_receber.total += valorLiquido;
                }
            });

            atualizarCards({ recebido, a_receber, atrasado });
        }

        function atualizarCards(data) {
            // Recebido
            document.getElementById('valorRecebido').textContent =
                formatarMoeda(data.recebido.total || 0);
            document.getElementById('qtdRecebido').textContent = data.recebido.qtd || 0;

            // A Receber
            document.getElementById('valorAReceber').textContent =
                formatarMoeda(data.a_receber.total || 0);
            document.getElementById('qtdAReceber').textContent = data.a_receber.qtd || 0;

            // Atrasado
            document.getElementById('valorAtrasado').textContent =
                formatarMoeda(data.atrasado.total || 0);
            document.getElementById('qtdAtrasado').textContent = data.atrasado.qtd || 0;
        }

        function atualizarCardsFinanceiros() {
            // Juros de Adiantamento
            document.getElementById('valorJuros').textContent =
                formatarMoeda(analiseFinanceira.juros || 0);

            // Reten√ß√£o Equatorial
            document.getElementById('valorRetencaoEquatorial').textContent =
                formatarMoeda(analiseFinanceira.retencao_equatorial || 0);

            // ISS
            document.getElementById('valorISS').textContent =
                formatarMoeda(analiseFinanceira.iss || 0);

            // INSS
            document.getElementById('valorINSS').textContent =
                formatarMoeda(analiseFinanceira.inss || 0);
        }

        function configurarTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filtrarTabela();
                });
            });
        }

        function filtrarTabela() {
            const tabAtiva = document.querySelector('.nav-tab.active').dataset.tab;
            const tipoSelecionado = document.getElementById('filtroTipo').value;
            const tbody = document.getElementById('tabelaNotas');

            // Recalcula os cards quando filtrar
            recalcularCards();

            let notasFiltradas = notasData.filter(nota => {
                // Filtro por situa√ß√£o (aba)
                let passaSituacao = true;
                if (tabAtiva === 'atrasados') {
                    passaSituacao = nota.situacao === 'ATRASADO';
                } else if (tabAtiva === 'a-receber') {
                    passaSituacao = nota.situacao === 'A_RECEBER';
                }

                // Filtro por tipo
                let passaTipo = true;
                if (tipoSelecionado !== '') {
                    passaTipo = nota.tipo === tipoSelecionado;
                }

                return passaSituacao && passaTipo;
            });

            if (notasFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #64748b;">
                            Nenhuma nota fiscal encontrada com os filtros selecionados
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = notasFiltradas.map(nota => {
                // USA APENAS Valor Nominal Confer√™ncia (coluna M)
                const valorLiquido = nota.valor_liquido || 0;

                const statusClass = nota.status_recebimento.toLowerCase();
                const situacaoClass = nota.situacao === 'ATRASADO' ? 'atrasado' : 'a-receber';
                const diasTexto = nota.situacao === 'ATRASADO'
                    ? `${Math.abs(nota.dias_diferenca)} dias atrasado`
                    : `Vence em ${Math.abs(nota.dias_diferenca)} dias`;

                // Formata o tipo para exibi√ß√£o
                let tipoExibicao = nota.tipo;
                if (nota.tipo === 'CONSTRUCAO') tipoExibicao = 'Constru√ß√£o';
                if (nota.tipo === 'ENSAIO DIELETRICO') tipoExibicao = 'Ensaio Diel√©trico';
                if (nota.tipo === 'TRANSPORTE') tipoExibicao = 'Transporte (NF)';
                if (nota.tipo === 'TRANSPORTE_CTE') tipoExibicao = 'Transporte (CT-e)';

                return `
                    <tr>
                        <td><strong>${nota.numero_nf}</strong></td>
                        <td>${formatarData(nota.data_emissao)}</td>
                        <td>${tipoExibicao}</td>
                        <td>${nota.tomador || '-'}</td>
                        <td><strong>${formatarMoeda(valorLiquido)}</strong></td>
                        <td>${formatarData(nota.data_vencimento)}</td>
                        <td><span class="badge ${statusClass}">${nota.status_recebimento}</span></td>
                        <td><span class="badge ${situacaoClass}">${diasTexto}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function formatarData(data) {
            if (!data) return '-';
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        }
    </script>
</body>
</html>